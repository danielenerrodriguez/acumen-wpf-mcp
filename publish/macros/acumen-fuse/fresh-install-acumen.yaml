name: Fresh Install Acumen
description: >-
  Installs Acumen from an installer .exe. If no installer path is provided,
  opens a file browser dialog for the user to pick the installer. Extracts the
  product GUID, generates a silent response file, and performs a fully silent
  install with default settings.
timeout: 600
parameters:
  - name: installerPath
    description: Full path to the Acumen installer .exe (leave empty for file picker)
    required: false
    default: ""
  - name: installDir
    description: Installation directory (leave empty for default)
    required: false
    default: ""
steps:
  # Step 1: If no installer path provided, open a file picker dialog
  - action: run_script
    command: "powershell.exe"
    arguments: '-NoProfile -ExecutionPolicy Bypass -STA -Command "$p = ''{{installerPath}}''; if ($p -and (Test-Path $p)) { Write-Output $p; exit 0 }; Add-Type -AssemblyName System.Windows.Forms; $d = New-Object System.Windows.Forms.OpenFileDialog; $d.Title = ''Select Acumen Installer''; $d.Filter = ''Installer (*.exe)|*.exe|All files (*.*)|*.*''; $d.InitialDirectory = [Environment]::GetFolderPath(''Desktop''); if ($d.ShowDialog() -eq ''OK'') { Write-Output $d.FileName } else { Write-Error ''No file selected''; exit 1 }"'
    save_output_as: installerExe
    timeout: 120

  # Step 2: Extract the product GUID from the installer
  # Run the installer with /? to get help (exits immediately) then check
  # the InstallShield temp extraction for setup.ini containing the GUID.
  # Alternatively, parse the version from the filename and use known GUIDs.
  - action: run_script
    command: "powershell.exe"
    arguments: '-NoProfile -ExecutionPolicy Bypass -Command "$exe = ''{{installerExe}}''; $name = [System.IO.Path]::GetFileNameWithoutExtension($exe); $verMatch = [regex]::Match($name, ''(\d+)(\d{2})''); if ($verMatch.Success) { $major = $verMatch.Groups[1].Value; $minor = $verMatch.Groups[2].Value; $verStr = \"$major.$minor\" } else { $verStr = ''unknown'' }; Write-Output $verStr"'
    save_output_as: versionHint
    timeout: 15

  # Step 3: Determine install directory
  - action: run_script
    command: "powershell.exe"
    arguments: '-NoProfile -ExecutionPolicy Bypass -Command "$d = ''{{installDir}}''; if ($d) { Write-Output $d } else { Write-Output ''C:\Program Files\Deltek\Acumen {{versionHint}}'' }"'
    save_output_as: targetDir
    timeout: 10

  # Step 4: Generate silent response file
  # Uses a generic approach â€” runs the installer silently and it will
  # use the response file to answer all dialogs automatically.
  - action: run_script
    command: "powershell.exe"
    arguments: '-NoProfile -ExecutionPolicy Bypass -Command "$dir = ''{{targetDir}}''; $lines = @(''[InstallShield Silent]'',''Version=v7.00'',''File=Response File'',''[File Transfer]'',''OverwrittenReadOnly=NoToAll'',''[{85A78158-2315-4AE9-8910-E1D495C4F8BC}-DlgOrder]'',''Dlg0={85A78158-2315-4AE9-8910-E1D495C4F8BC}-MessageBox-0'',''Count=5'',''Dlg1={85A78158-2315-4AE9-8910-E1D495C4F8BC}-SdWelcome-0'',''Dlg2={85A78158-2315-4AE9-8910-E1D495C4F8BC}-SdAskDestPath2-0'',''Dlg3={85A78158-2315-4AE9-8910-E1D495C4F8BC}-SdStartCopy-0'',''Dlg4={85A78158-2315-4AE9-8910-E1D495C4F8BC}-SdFinish-0'',''[{85A78158-2315-4AE9-8910-E1D495C4F8BC}-MessageBox-0]'',''Result=1'',''[{85A78158-2315-4AE9-8910-E1D495C4F8BC}-SdWelcome-0]'',''Result=1'',''[{85A78158-2315-4AE9-8910-E1D495C4F8BC}-SdAskDestPath2-0]'',\"szDir=$dir\",''Result=1'',''[{85A78158-2315-4AE9-8910-E1D495C4F8BC}-SdStartCopy-0]'',''Result=1'',''[Application]'',''Name=Acumen'',''Version=8.12.0'',''Company=Deltek'',''Lang=0409'',''[{85A78158-2315-4AE9-8910-E1D495C4F8BC}-SdFinish-0]'',''Result=1'',''bOpt1=0'',''bOpt2=0''); $path = Join-Path $env:TEMP ''install-acumen.iss''; $lines | Set-Content -Path $path -Encoding ASCII; Write-Output $path"'
    save_output_as: issPath
    timeout: 15

  # Step 5: Run the silent install
  - action: run_script
    command: "powershell.exe"
    arguments: '-NoProfile -ExecutionPolicy Bypass -Command "$proc = Start-Process -FilePath ''{{installerExe}}'' -ArgumentList ''-s -SMS -f1{{issPath}}'' -Wait -PassThru; exit $proc.ExitCode"'
    ignore_exit_code: true
    timeout: 60
