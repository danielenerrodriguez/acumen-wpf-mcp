@implements IDisposable
@inject IAppState State

<div class="flex flex-col h-full">
    <div class="panel-header flex items-center justify-between px-3 py-2 shrink-0">
        <span class="text-xs font-semibold text-gray-500 uppercase tracking-wider">Actions</span>
        <button @onclick="ToggleWatch"
                class="text-xs px-2.5 py-1 rounded-md font-medium transition @(Watching ? "bg-deltek text-white shadow-sm" : "btn-secondary")"
                title="@(Watching ? "Stop watching focus" : "Watch focused element in the attached app")">
            @(Watching ? "Watching" : "Watch")
        </button>
    </div>
    <div class="flex-1 overflow-auto p-3 space-y-3 text-xs">

        @* Attach *@
        <div>
            <label class="text-gray-500 font-medium block mb-1">Attach</label>
            <select @bind="_selectedPid" @bind:after="OnProcessSelected"
                    disabled="@_attaching"
                    class="input-field w-full truncate">
                <option value="0">@(_attaching ? "Attaching..." : "-- Select process --")</option>
                @if (_processes != null)
                {
                    @foreach (var p in _processes)
                    {
                        <option value="@p.Pid" title="@p.Title">@p.Name (@p.Pid)</option>
                    }
                }
            </select>
        </div>

        @* Element actions *@
        @if (SelectedRefKey != null)
        {
            <div>
                <label class="text-gray-500 font-medium block mb-1">Element: <span class="text-deltek font-semibold">@SelectedRefKey</span></label>
                <div class="flex flex-wrap gap-1">
                    <button @onclick="DoClick" class="btn-secondary">Click</button>
                    <button @onclick="DoRightClick" class="btn-secondary">RClick</button>
                    <button @onclick="DoGetValue" class="btn-secondary">GetValue</button>
                    <button @onclick="DoFocus" class="btn-secondary">Focus</button>
                </div>
            </div>

            @* Set Value *@
            <div>
                <label class="text-gray-500 font-medium block mb-1">Set Value</label>
                <div class="flex gap-1">
                    <input @bind="_setValue" @bind:event="oninput" placeholder="Value"
                           class="input-field min-w-0 flex-1" />
                    <button @onclick="DoSetValue" class="btn-primary">Set</button>
                </div>
            </div>

            @* Verify *@
            <div>
                <label class="text-gray-500 font-medium block mb-1">Verify</label>
                <div class="flex gap-1">
                    <select @bind="_verifyProperty"
                            class="input-field shrink-0">
                        <option value="value">value</option>
                        <option value="name">name</option>
                        <option value="toggle_state">toggle_state</option>
                        <option value="is_enabled">is_enabled</option>
                        <option value="expand_state">expand_state</option>
                        <option value="is_selected">is_selected</option>
                        <option value="control_type">control_type</option>
                        <option value="automation_id">automation_id</option>
                    </select>
                    <input @bind="_verifyExpected" @bind:event="oninput" placeholder="Expected"
                           class="input-field min-w-0 flex-1" />
                    <button @onclick="DoVerify" class="btn-primary">Verify</button>
                </div>
            </div>
        }
        else
        {
            @* Focus button when no element selected *@
            <div>
                <label class="text-gray-500 font-medium block mb-1">Global</label>
                <div class="flex gap-1">
                    <button @onclick="DoFocus" class="btn-secondary">Focus</button>
                </div>
            </div>
        }

        @* Send Keys *@
        <div>
            <label class="text-gray-500 font-medium block mb-1">Keys</label>
            <div class="flex gap-1">
                <input @bind="_keysText" @bind:event="oninput" placeholder="Ctrl+S, Alt+F4..."
                       class="input-field min-w-0 flex-1" />
                <button @onclick="DoSendKeys" class="btn-primary">Send</button>
            </div>
        </div>

        @* Type text *@
        <div>
            <label class="text-gray-500 font-medium block mb-1">Type</label>
            <div class="flex gap-1">
                <input @bind="_typeText" @bind:event="oninput" placeholder="Text to type..."
                       class="input-field min-w-0 flex-1" />
                <button @onclick="DoTypeText" class="btn-primary">Type</button>
            </div>
        </div>

        @* Find *@
        <div>
            <label class="text-gray-500 font-medium block mb-1">Find</label>
            <div class="flex gap-1 mb-1">
                <input @bind="_findAutomationId" @bind:event="oninput" placeholder="AutomationId"
                       class="input-field min-w-0 flex-1" />
                <input @bind="_findName" @bind:event="oninput" placeholder="Name"
                       class="input-field min-w-0 flex-1" />
            </div>
            <button @onclick="DoFind" class="btn-primary w-full">Find</button>
        </div>
    </div>
</div>

@code {
    [Parameter] public string? SelectedRefKey { get; set; }
    [Parameter] public bool Watching { get; set; }
    [Parameter] public EventCallback<bool> OnWatchToggled { get; set; }
    [Parameter] public EventCallback<string?> OnElementSelected { get; set; }

    private List<ProcessInfo>? _processes;
    private int _selectedPid;
    private bool _attaching;
    private Timer? _refreshTimer;

    private async Task ToggleWatch() => await OnWatchToggled.InvokeAsync(!Watching);

    private string _keysText = "";
    private string _typeText = "";
    private string _setValue = "";
    private string _verifyProperty = "value";
    private string _verifyExpected = "";
    private string _findAutomationId = "";
    private string _findName = "";

    protected override void OnInitialized()
    {
        RefreshProcessList();
        _refreshTimer = new Timer(_ =>
        {
            if (_attaching) return;
            InvokeAsync(() =>
            {
                RefreshProcessList();
                StateHasChanged();
            });
        }, null, 5000, 5000);
    }

    private void RefreshProcessList()
    {
        try { _processes = State.ListWindowedProcesses(); } catch { _processes = new(); }
    }

    private async Task OnProcessSelected()
    {
        if (_selectedPid == 0 || _attaching) return;
        var proc = _processes?.FirstOrDefault(p => p.Pid == _selectedPid);
        if (proc == null) return;

        _attaching = true;
        StateHasChanged();
        try
        {
            await State.AttachAsync(proc.Name);
        }
        finally
        {
            _attaching = false;
            _selectedPid = 0; // Reset to placeholder
            StateHasChanged();
        }
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }

    private async Task DoClick()
    {
        if (SelectedRefKey == null) return;
        await State.ClickAsync(SelectedRefKey);
    }

    private async Task DoRightClick()
    {
        if (SelectedRefKey == null) return;
        await State.RightClickAsync(SelectedRefKey);
    }

    private async Task DoGetValue()
    {
        if (SelectedRefKey == null) return;
        await State.GetValueAsync(SelectedRefKey);
    }

    private async Task DoFocus() => await State.FocusAsync();

    private async Task DoSendKeys()
    {
        if (string.IsNullOrWhiteSpace(_keysText)) return;
        await State.SendKeysAsync(_keysText.Trim());
    }

    private async Task DoTypeText()
    {
        if (string.IsNullOrWhiteSpace(_typeText)) return;
        await State.TypeTextAsync(_typeText);
    }

    private async Task DoSetValue()
    {
        if (SelectedRefKey == null || string.IsNullOrEmpty(_setValue)) return;
        await State.SetValueAsync(SelectedRefKey, _setValue);
    }

    private async Task DoVerify()
    {
        if (SelectedRefKey == null || string.IsNullOrWhiteSpace(_verifyExpected)) return;
        await State.VerifyAsync(SelectedRefKey, _verifyProperty, _verifyExpected.Trim());
    }

    private async Task DoFind()
    {
        var aid = string.IsNullOrWhiteSpace(_findAutomationId) ? null : _findAutomationId.Trim();
        var name = string.IsNullOrWhiteSpace(_findName) ? null : _findName.Trim();
        if (aid == null && name == null) return;
        var result = await State.FindAsync(aid, name, null, null);
        // Auto-select the found element
        if (result != null)
            await OnElementSelected.InvokeAsync(result.Element.RefKey);
    }

}
