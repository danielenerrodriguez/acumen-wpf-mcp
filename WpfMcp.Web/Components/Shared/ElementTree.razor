@inject IAppState State

<div class="flex flex-col h-full">
    <div class="panel-header flex items-center justify-between px-3 py-2 shrink-0">
        <span class="text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase tracking-wider">Element Tree</span>
        <button @onclick="RefreshAsync" class="btn-secondary text-xs" title="Refresh">
            Refresh
        </button>
    </div>
    <div class="flex-1 overflow-auto p-1 text-xs font-mono bg-surface dark:bg-dm-light">
        @if (_rootNodes == null)
        {
            <p class="text-gray-400 dark:text-gray-500 p-2">Loading...</p>
        }
        else if (_rootNodes.Count == 0)
        {
            <p class="text-gray-400 dark:text-gray-500 p-2">No elements. Attach to a process first.</p>
        }
        else
        {
            @foreach (var node in _rootNodes)
            {
                <TreeNode Node="node" Depth="0" SelectedRefKey="@SelectedRefKey" HighlightRuntimeId="@HighlightRuntimeId" OnSelect="SelectNode" />
            }
        }
    </div>
</div>

@code {
    [Parameter] public string? SelectedRefKey { get; set; }
    [Parameter] public string? HighlightRuntimeId { get; set; }
    [Parameter] public EventCallback<string?> OnElementSelected { get; set; }

    private List<ElementInfo>? _rootNodes;

    protected override async Task OnInitializedAsync()
    {
        await RefreshAsync();
    }

    /// <summary>Reload root children. Called externally by Dashboard on attach change.</summary>
    public async void Refresh()
    {
        await RefreshAsync();
    }

    private async Task RefreshAsync()
    {
        try
        {
            _rootNodes = await State.GetRootChildrenAsync();
        }
        catch
        {
            _rootNodes = new();
        }
        StateHasChanged();
    }

    private async Task SelectNode(string refKey)
    {
        await OnElementSelected.InvokeAsync(refKey);
    }
}
