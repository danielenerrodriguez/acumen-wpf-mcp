@inject IAppState State

<div class="flex flex-col h-full">
    <div class="flex items-center justify-between px-3 py-2 bg-surface-light border-b border-gray-700 shrink-0">
        <span class="text-xs font-semibold text-gray-400 uppercase tracking-wider">Macros</span>
        <button @onclick="RefreshMacros" class="text-xs text-gray-400 hover:text-accent-light px-2 py-0.5 rounded hover:bg-surface-lighter transition">
            Refresh
        </button>
    </div>
    <div class="flex-1 flex overflow-hidden text-xs">
        @* Macro list *@
        <div class="w-48 border-r border-gray-700 overflow-auto shrink-0">
            @if (_macros == null || _macros.Count == 0)
            {
                <p class="text-gray-500 p-2">No macros found.</p>
            }
            else
            {
                @foreach (var m in _macros)
                {
                    <button @onclick="() => SelectMacro(m)"
                            class="w-full text-left px-3 py-1.5 hover:bg-surface-lighter transition truncate @(m == _selected ? "bg-surface-lighter text-accent-light" : "text-gray-300")">
                        @m.DisplayName
                    </button>
                }
            }
        </div>

        @* Macro detail / run *@
        <div class="flex-1 overflow-auto p-3">
            @if (_selected == null)
            {
                <p class="text-gray-500">Select a macro to run.</p>
            }
            else
            {
                <div class="space-y-2">
                    <div>
                        <span class="text-accent-light font-semibold">@_selected.DisplayName</span>
                        <p class="text-gray-500 mt-0.5">@_selected.Description</p>
                    </div>

                    @if (_selected.Parameters.Count > 0)
                    {
                        <div class="space-y-1">
                            @foreach (var p in _selected.Parameters)
                            {
                                <div class="flex items-center gap-2">
                                    <label class="text-gray-400 w-28 shrink-0 truncate" title="@p.Description">
                                        @p.Name@(p.Required ? "*" : "")
                                    </label>
                                    <input @bind="_paramValues[p.Name]" @bind:event="oninput"
                                           placeholder="@(p.Default ?? p.Description)"
                                           class="flex-1 bg-surface border border-gray-700 rounded px-2 py-1 text-gray-200 focus:border-accent outline-none" />
                                </div>
                            }
                        </div>
                    }

                    <button @onclick="RunMacro" disabled="@_running"
                            class="px-3 py-1.5 bg-accent text-white rounded hover:bg-accent/80 transition disabled:opacity-50 disabled:cursor-not-allowed">
                        @(_running ? "Running..." : "Run Macro")
                    </button>
                </div>
            }
        </div>
    </div>
</div>

@code {
    private List<MacroSummary>? _macros;
    private MacroSummary? _selected;
    private Dictionary<string, string> _paramValues = new();
    private bool _running;

    protected override void OnInitialized()
    {
        RefreshMacros();
    }

    private void RefreshMacros()
    {
        try { _macros = State.ListMacros(); } catch { _macros = new(); }
        StateHasChanged();
    }

    private void SelectMacro(MacroSummary macro)
    {
        _selected = macro;
        _paramValues = new();
        foreach (var p in macro.Parameters)
        {
            _paramValues[p.Name] = p.Default ?? "";
        }
    }

    private async Task RunMacro()
    {
        if (_selected == null || _running) return;
        _running = true;
        StateHasChanged();

        try
        {
            // Filter out empty params
            var filtered = _paramValues
                .Where(kv => !string.IsNullOrEmpty(kv.Value))
                .ToDictionary(kv => kv.Key, kv => kv.Value);

            await State.RunMacroAsync(_selected.Name, filtered);
        }
        catch { }
        finally
        {
            _running = false;
            StateHasChanged();
        }
    }
}
