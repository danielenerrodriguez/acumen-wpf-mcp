@inject IAppState State

<div>
    <div class="tree-node flex items-center gap-1 py-0.5 px-1 cursor-pointer rounded @NodeCssClass"
         style="padding-left: @(Depth * 16 + 4)px"
         @onclick="Select">

        @* Expand/collapse chevron *@
        @if (Node.HasChildren)
        {
            <button @onclick="ToggleExpand" @onclick:stopPropagation="true"
                    class="w-4 h-4 flex items-center justify-center text-gray-400 dark:text-gray-500 hover:text-deltek dark:hover:text-accent-light shrink-0">
                <span class="text-[10px]">@(_expanded ? "\u25BC" : "\u25B6")</span>
            </button>
        }
        else
        {
            <span class="w-4 shrink-0"></span>
        }

        @* Control type badge *@
        <span class="text-deltek dark:text-accent-light font-medium shrink-0">[@Node.ControlType]</span>

        @* Name or AutomationId *@
        @if (!string.IsNullOrEmpty(Node.Name))
        {
            <span class="text-gray-700 dark:text-gray-300 truncate" title="@Node.Name">@Truncate(Node.Name, 30)</span>
        }
        @if (!string.IsNullOrEmpty(Node.AutomationId))
        {
            <span class="text-amber-600 dark:text-yellow-500 truncate" title="@Node.AutomationId">#@Truncate(Node.AutomationId, 24)</span>
        }

        @* Ref key *@
        <span class="text-gray-400 dark:text-gray-600 ml-auto shrink-0">@Node.RefKey</span>
    </div>

    @* Children *@
    @if (_expanded)
    {
        var children = GetChildren();
        if (children != null)
        {
            @foreach (var child in children)
            {
                <TreeNode Node="child" Depth="Depth + 1" SelectedRefKey="@SelectedRefKey"
                          HighlightRuntimeIds="@HighlightRuntimeIds"
                          AutoExpandedRuntimeIds="@AutoExpandedRuntimeIds"
                          PreloadedChildren="@PreloadedChildren"
                          CollapseVersion="@CollapseVersion"
                          OnSelect="OnSelect" />
            }
        }
    }
</div>

@code {
    [Parameter, EditorRequired] public ElementInfo Node { get; set; } = default!;
    [Parameter] public int Depth { get; set; }
    [Parameter] public string? SelectedRefKey { get; set; }
    [Parameter] public HashSet<string>? HighlightRuntimeIds { get; set; }
    [Parameter] public HashSet<string>? AutoExpandedRuntimeIds { get; set; }
    [Parameter] public Dictionary<string, List<ElementInfo>>? PreloadedChildren { get; set; }
    [Parameter] public int CollapseVersion { get; set; }
    [Parameter] public EventCallback<string> OnSelect { get; set; }

    private bool _expanded;
    private List<ElementInfo>? _children;
    private int _lastCollapseVersion;

    private bool IsSelected => SelectedRefKey == Node.RefKey;
    private bool IsHighlighted => !string.IsNullOrEmpty(Node.RuntimeId)
        && HighlightRuntimeIds?.Contains(Node.RuntimeId) == true
        && !IsSelected;

    private string NodeCssClass => IsSelected ? "selected" : IsHighlighted ? "watched" : "";

    protected override void OnParametersSet()
    {
        // React to collapse/expand version changes from ElementTree
        if (CollapseVersion != _lastCollapseVersion)
        {
            _lastCollapseVersion = CollapseVersion;
            // Auto-expand if in the set, otherwise collapse
            var shouldExpand = !string.IsNullOrEmpty(Node.RuntimeId)
                && AutoExpandedRuntimeIds?.Contains(Node.RuntimeId) == true;
            _expanded = shouldExpand;
            // Clear locally loaded children so preloaded ones take effect
            if (shouldExpand)
                _children = null;
        }
    }

    private List<ElementInfo>? GetChildren()
    {
        // Prefer locally loaded children (from manual expand)
        if (_children != null)
            return _children;
        // Fall back to preloaded children (from expand-to-highlights)
        if (!string.IsNullOrEmpty(Node.RuntimeId)
            && PreloadedChildren?.TryGetValue(Node.RuntimeId, out var preloaded) == true)
            return preloaded;
        return null;
    }

    private async Task ToggleExpand()
    {
        _expanded = !_expanded;
        if (_expanded && GetChildren() == null)
        {
            try
            {
                _children = await State.GetChildrenAsync(Node.RefKey);
            }
            catch
            {
                _children = new();
            }
        }
    }

    private async Task Select()
    {
        await OnSelect.InvokeAsync(Node.RefKey);
    }

    private static string Truncate(string s, int max) =>
        s.Length <= max ? s : s[..max] + "...";
}
