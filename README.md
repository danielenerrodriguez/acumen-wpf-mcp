# WPF UIA MCP Server

A tool for automating WPF desktop applications. Double-click a shortcut to run a macro, or let an AI agent drive the UI for you.

Originally built for **Deltek Acumen Fuse**, but designed to work with any WPF application.

## What It Does

- **Run macros** — Pre-built YAML workflows that automate common tasks (import files, run analyses, navigate menus)
- **Double-click shortcuts** — Export macros as Windows shortcuts (.lnk) that anyone can run
- **AI agent integration** — An MCP server that lets AI agents interact with WPF apps through UI Automation
- **Knowledge bases** — Structured reference data (automation IDs, keytips, workflows) that help AI agents navigate applications efficiently
- **Web dashboard** — Browser-based UI at `http://localhost:5112` for element inspection, actions, and macro running
- **Watch mode** — Record focus, hover, keypress, and property changes to understand user workflows

## Getting Started

### From a Release Zip

1. Download and extract `WpfMcp.zip` from the [latest release](https://github.com/danielenerrodriguez/acumen-wpf-mcp/releases)
2. Double-click `WpfMcp.exe` to start the elevated server (approve the UAC prompt)
3. Open `http://localhost:5112` for the web dashboard
4. Run `export-shortcuts.cmd` to generate Windows shortcuts for all macros

Your folder should look like:

```
WpfMcp/
  WpfMcp.exe                ← double-click to start server + web dashboard
  export-shortcuts.cmd      ← generates .lnk shortcuts for all macros
  launch-cli.cmd            ← opens interactive CLI mode
  run-indefinite.cmd        ← starts server with no idle timeout (runs forever)
  macros/
    acumen-fuse/
      import-xer.yaml
      launch.yaml
      ...
  Shortcuts/                ← generated by export-shortcuts.cmd
    acumen-fuse/
      import-xer.lnk       ← double-click to run
      launch.lnk
      ...
```

### From Source

```
cd C:\WpfMcp
dotnet build -c Release
```

Then export shortcuts pointing to your macros:

```
WpfMcp.exe --export-all --macros-path C:\WpfMcp\publish\macros
```

### Prerequisites

- Windows 10/11
- Elevation capability (UAC or BeyondTrust) — required for UI Automation access to WPF apps
- .NET 9 SDK only needed if building from source

## Macros

Macros are reusable, YAML-defined step sequences that automate UI workflows. They support parameters, timeouts, and retry logic.

### Running Macros

**Double-click a shortcut** — The simplest way. See [Macro Export](#macro-export-shortcuts) below.

**Drag and drop** — Drag a `.yaml` file onto `WpfMcp.exe`.

**CLI mode** — Run `WpfMcp.exe` and use the interactive prompt:

```
wpf> macro acumen-fuse/import-xer filePath=C:\data\schedule.xer
```

**AI agent** — The agent calls `wpf_macro` via the MCP protocol (see [MCP Integration](#mcp-integration)).

### Folder Structure

```
macros/
  acumen-fuse/
    _knowledge.yaml          ← knowledge base (not a macro)
    launch.yaml
    import-xer.yaml
    import-xer-and-analyze.yaml
    export-to-excel.yaml
    ...
  another-app/
    some-workflow.yaml
```

Macro names are derived from the relative path without extension (e.g., `acumen-fuse/import-xer`).

You can override the macros location with `--macros-path <path>` or the `WPFMCP_MACROS_PATH` environment variable.

### YAML Schema

```yaml
name: Human-readable display name
description: What this macro does
timeout: 30                         # Max seconds for entire macro (default: 60)

parameters:                         # Optional
  - name: filePath
    description: Full path to the file
    required: true
  - name: format
    description: Output format
    required: false
    default: "pdf"

steps:
  - action: focus                   # Bring app window to foreground
  - action: send_keys
    keys: "Alt,F"                   # Keyboard input
  - action: wait
    seconds: 0.5                    # Pause between steps
  - action: find
    name: Import                    # Find element by properties
    control_type: MenuItem
    save_as: importMenuItem         # Save ref for later steps
    timeout: 5                      # Per-step timeout (retries until found)
    retry_interval: 2               # Seconds between retries
  - action: click
    ref: importMenuItem             # Click a saved element
  - action: type
    text: "{{filePath}}"            # Parameter substitution
  - action: verify
    ref: importMenuItem             # Check an element property
    property: name                  # value, name, toggle_state, is_enabled, etc.
    expected: "Workbook1 (0)"
    match_mode: not_equals          # equals (default), contains, not_equals, regex, starts_with
    message: "Custom failure msg"   # Optional
  - action: run_script
    command: "powershell.exe"       # Run any command/script
    arguments: "-NoProfile -Command \"Get-Date\""
    save_output_as: dateOutput      # Capture stdout as {{dateOutput}}
    ignore_exit_code: true          # Don't fail on non-zero exit
```

### Supported Actions

| Action | Description | Key Properties |
|--------|-------------|----------------|
| `focus` | Bring application window to foreground | — |
| `attach` | Attach to a process | `process_name`, `pid` |
| `launch` | Launch an application | `exe_path`, `arguments`, `working_directory`, `if_not_running`, `timeout` |
| `wait_for_window` | Wait for window to be ready | `title_contains`, `timeout`, `retry_interval` |
| `wait_for_enabled` | Wait for element to become enabled/disabled | `automation_id`, `name`, `ref`, `enabled`, `timeout`, `retry_interval` |
| `find` | Find element with retry loop | `automation_id`, `name`, `class_name`, `control_type`, `save_as`, `timeout`, `retry_interval` |
| `find_by_path` | Find element by hierarchical path | `path` (list), `save_as`, `timeout`, `retry_interval` |
| `click` | Click an element | `ref` (element ref or alias from `save_as`) |
| `right_click` | Right-click an element | `ref` |
| `type` | Type text into focused element | `text` |
| `send_keys` | Send keyboard shortcuts | `keys` |
| `set_value` | Set element value via UIA ValuePattern | `ref`, `value` |
| `get_value` | Get element value via UIA ValuePattern | `ref` |
| `file_dialog` | Navigate a file dialog to select a file | `text` (the file path) |
| `wait` | Pause execution | `seconds` |
| `snapshot` | Capture the UI tree | `max_depth` |
| `screenshot` | Capture window image | — |
| `children` | List children of element | `ref`, `save_as` |
| `properties` | Get element properties | `ref` |
| `verify` | Verify an element property value | `ref`, `property`, `expected`, `match_mode` (equals/contains/not_equals/regex/starts_with), `message` |
| `run_script` | Run an external command/script, optionally capture output | `command`, `arguments`, `working_directory`, `save_output_as`, `ignore_exit_code`, `timeout` |
| `include` | Inline steps from another macro (load-time) | `macro_name`, `params` |
| `macro` | Run another macro as a nested call (runtime) | `macro_name`, `params` |

### Macro Reuse

Macros can include steps from other macros, enabling reusable building blocks.

**`action: include`** (recommended) — Steps are **inlined at load time**, producing a flat step list with zero runtime overhead:
```yaml
steps:
  - action: include
    macro_name: acumen-fuse/launch      # Include all steps from this macro
    params:
      exePath: "{{exePath}}"            # Remap parameters
  - action: send_keys
    keys: "Alt,F"
```

- Supports nested includes (A includes B includes C)
- Detects circular includes
- Works in all execution paths: MCP, web dashboard, CLI, drag-and-drop

**`action: macro`** — Executes a macro at **runtime** as a nested call. Uses the nested macro's own timeout. Not recommended for MCP tool calls (nested execution time can exceed the ~15-20s MCP transport timeout).

### Parameter Substitution

Use `{{paramName}}` placeholders in any string property. Parameters are resolved from:
- Command-line arguments (`filePath=C:\data\file.xer`)
- Default values in the YAML definition
- Interactive prompts (when running via shortcut or drag-and-drop)

**Auto-save defaults**: When running from the web dashboard, parameter values are automatically saved back to the YAML file as new `default:` values. The next time the macro is opened, inputs pre-fill with the last-used values.

**Browse buttons**: Path-like parameters (names containing `path`, `file`, `dir`, or `folder`) show a browse button that opens a native Windows file/folder dialog, starting in the directory of the current input value.

### Timeouts and Retry

- **Macro-level timeout** (`timeout` at root): Maximum seconds for the entire macro. Default: 60.
- **Step-level timeout** (`timeout` on a step): Maximum seconds for that step. Default: 5. For `find` and `find_by_path` actions, the step retries at `retry_interval` (default: 1s) until the timeout expires.
- **Crash detection**: If the target process exits mid-macro, execution stops immediately with a clear error.
- **Cancellation**: Running macros can be cancelled from the web dashboard (Cancel button) or CLI (`Ctrl+C`). Cancellation kills any running child processes (e.g., `run_script` steps) and stops at the current step.

### Examples

**Simple: Open File Menu**
```yaml
name: Open File Menu
description: Opens the Acumen Fuse File menu via ribbon keytips
timeout: 10
steps:
  - action: focus
  - action: send_keys
    keys: "Alt,F"
  - action: wait
    seconds: 0.5
```

**With Parameters: Import File**
```yaml
name: Import File
description: Opens the Import dialog and types a file path
timeout: 30
parameters:
  - name: filePath
    description: Full path to the file to import
    required: true
steps:
  - action: focus
  - action: send_keys
    keys: "Alt,F"
  - action: wait
    seconds: 0.5
  - action: find
    name: Import
    control_type: MenuItem
    save_as: importMenuItem
    timeout: 5
  - action: click
    ref: importMenuItem
  - action: wait
    seconds: 1
  - action: type
    text: "{{filePath}}"
  - action: send_keys
    keys: Enter
```

## Macro Export (Shortcuts)

Export macros as Windows shortcut (.lnk) files that anyone can double-click to run — no AI agent or MCP client needed.

### How It Works

1. The shortcut launches `WpfMcp.exe` with the macro YAML path as an argument
2. The program parses the YAML, prompts for any required parameters without defaults
3. Connects to the elevated server (launches it with UAC if not already running)
4. Executes the macro and shows the result

### Generating Shortcuts

```bash
# Run export-shortcuts.cmd (included in release zip)
export-shortcuts.cmd

# Or export manually
WpfMcp.exe --export-all

# Export a single macro (use CLI mode)
WpfMcp.exe --cli   # then: export acumen-fuse/import-xer

# Override output directory
WpfMcp.exe --export-all --shortcuts-path C:\Users\me\Desktop\MacroShortcuts

# Force overwrite existing shortcuts
WpfMcp.exe --export-all --force
```

### Elevation

Shortcuts do **not** require "Run as administrator". Elevation is handled internally:

- **First run**: UAC prompt appears once to start the elevated server
- **Subsequent runs**: Connects to the existing server silently
- **After 1 hour idle** (default): Server shuts down, next run prompts again. Use `--no-idle` or `--idle-timeout <minutes>` to change

### Path Resolution

The shortcuts folder is resolved in this priority:

1. Explicit `--shortcuts-path` argument
2. `WPFMCP_SHORTCUTS_PATH` environment variable
3. `Shortcuts/` as a sibling of the macros folder (default)

## Knowledge Bases

Knowledge bases are YAML files that provide structured navigation context for a specific application — automation IDs, keytip sequences, ribbon layout, workflows, and more.

### File Convention

- Named `_knowledge.yaml` (underscore prefix, skipped by the macro loader)
- Located in product subfolders: `macros/acumen-fuse/_knowledge.yaml`
- Must have `kind: knowledge-base` as a top-level field

### YAML Structure

```yaml
kind: knowledge-base
update_instructions: { ... }    # When/how AI agents should update this file
installation: { ... }           # Exe path, samples, templates, skills directories
application: { ... }            # Name, version, startup phases
keyboard_shortcuts: [ ... ]     # Global shortcuts (Ctrl+N, Ctrl+O, etc.)
keytips: { ... }                # Ribbon keytip sequences
ribbon: { ... }                 # Complete ribbon structure (tabs, groups, tools)
automation_ids: { ... }         # All known IDs organized by category
workflows: [ ... ]              # Step-by-step recipes for common tasks
navigation_tips: [ ... ]        # Practical tips for driving the app
data_formats: { ... }           # Supported import/export formats
```

### Current Knowledge Bases

| Product | File | Content |
|---------|------|---------|
| `acumen-fuse` | `macros/acumen-fuse/_knowledge.yaml` | 1800+ lines, 100+ automation IDs, 15 workflows, 19 navigation tips, verified keytip sequences |

## Web Dashboard

The elevated server hosts a **Blazor Server dashboard** at `http://localhost:5112` for interactive element inspection, actions, and macro running — no MCP client needed.

### Features

- **Element Tree** — Browse the UI automation tree with collapse/expand controls and watch-mode highlighting
- **Properties Panel** — View all properties of a selected element with change highlighting during watch mode
- **Actions Panel** — Click, right-click, type, send keys, set value, find elements, verify properties, and focus
- **Process Attach** — Select and attach to any windowed process from a dropdown
- **Macro Runner** — List, select, and run macros with parameter input; cancel running macros; double-click to open YAML in editor; browse buttons for path parameters; auto-saves parameter defaults after run
- **Log Panel** — Live log viewer with auto-scroll and clickable element references
- **Watch Mode** — Toggle focus/hover/keypress recording from the dashboard

### Theming

The dashboard supports **dual light/dark themes**:

- **Light theme** — Deltek-inspired: blue header (`#0066FF`), Inter font, warm gray (`#E8EBF0`) backgrounds
- **Dark theme** — Purple accents (`#7c3aed`), dark surface colors
- **Auto-detection** — Reads OS `prefers-color-scheme` on first visit
- **Persistence** — Saves to `localStorage`, sun/moon toggle in the header bar

### Access

The server auto-opens your default browser after 3 seconds if no client is already connected. You can also navigate to `http://localhost:5112` manually. WSL2 browsers cannot reach this port due to VM networking limitations.

## Watch Mode

Watch mode records what a user (or AI agent) does in the attached WPF application — useful for understanding workflows, debugging, and creating macros.

### What It Records

| Entry Type | Description |
|------------|-------------|
| **Focus** | Keyboard focus changed to a new element |
| **Hover** | Mouse cursor moved over a new element |
| **Keypress** | A key was pressed (with modifier combos like `Ctrl+S`) |
| **PropertyChange** | A property value changed on the tracked element |

### How to Use

**From the web dashboard**: Click the Watch toggle button in the Actions panel.

**From the CLI**:
```
wpf> watch         # Start recording
wpf> watch stop    # Stop and show results
wpf> watch status  # View current/last session
```

**From an AI agent** (MCP tools):
1. Call `wpf_watch_start` — session begins recording
2. User interacts with the application
3. Call `wpf_watch_stop` — receive the full session log
4. Analyze entries to understand the workflow
5. Optionally save as a macro via `wpf_save_macro`

### Session Output

```
Session: a1b2c3d4 | Started: 14:23:05 | Stopped: 14:25:12 | Entries: 47

14:23:05.123 [Focus]  [TextBox] #NameField  (Value="hello")
14:23:06.456 [Hover]  [Button] #SaveButton
14:23:07.789 [PropChange] [TextBox] #NameField  Value: "hello" → "hello world"
14:23:08.012 [Keypress]  Ctrl+S  (on [TextBox] #NameField)
```

---

## MCP Integration

For AI agents and developers. The MCP (Model Context Protocol) server lets AI agents drive WPF applications programmatically.

### Setup

Configure your MCP client to launch:

```json
{
  "wpf-uia": {
    "type": "local",
    "command": ["cmd.exe", "/c", "C:\\WpfMcp\\publish\\WpfMcp.exe --mcp-connect"]
  }
}
```

On first use, approve the UAC prompt to elevate the server. It stays running for 1 hour of idle time (configurable with `--idle-timeout` or `--no-idle`).

### MCP Tools

| Tool | Description |
|------|-------------|
| `wpf_attach` | Attach to a WPF process by name or PID; optionally launch if not running |
| `wpf_status` | Check attachment status (process name, PID, window title) |
| `wpf_snapshot` | Get the UI automation tree (configurable depth) |
| `wpf_find` | Find an element by AutomationId, Name, ClassName, or ControlType |
| `wpf_find_by_path` | Find an element by hierarchical path segments |
| `wpf_children` | List children of an element (or the main window) |
| `wpf_click` | Click an element by reference key |
| `wpf_right_click` | Right-click an element by reference key |
| `wpf_type` | Type text into the focused element |
| `wpf_send_keys` | Send keyboard input (`Ctrl+S`, `Alt,F`, `Enter`, etc.) |
| `wpf_set_value` | Set element value via UIA ValuePattern |
| `wpf_get_value` | Get element value via UIA ValuePattern |
| `wpf_file_dialog` | Navigate a file dialog to select a file |
| `wpf_focus` | Bring the application window to the foreground |
| `wpf_screenshot` | Capture the application window as a PNG |
| `wpf_properties` | Get detailed properties of a cached element |
| `wpf_macro` | Execute a named macro with optional parameters |
| `wpf_macro_list` | List all available macros, parameters, and knowledge base summaries |
| `wpf_save_macro` | Save a workflow as a reusable macro YAML file |
| `wpf_export_macro` | Export a macro (or all) as a double-clickable Windows shortcut |
| `wpf_watch_start` | Start a watch session recording focus, hover, keypress, and property changes |
| `wpf_watch_stop` | Stop the watch session and return all recorded entries |
| `wpf_watch_status` | Get the current or last watch session's entries |

### Element References

`wpf_find`, `wpf_find_by_path`, and `wpf_children` return element references (e.g., `e1`, `e2`). Use these refs with `wpf_click`, `wpf_right_click`, `wpf_properties`, etc. References persist across MCP client reconnections.

### Keyboard Input

- **Simultaneous keys**: `+` separator — `Ctrl+S`, `Alt+F4`, `Ctrl+Shift+N`
- **Sequential keys**: `,` separator — `Alt,F` (press Alt, release, then press F)
- **Single keys**: `Enter`, `Escape`, `Tab`, `F5`, `Delete`

### MCP Resources

Knowledge bases are available as MCP resources:

```
knowledge://acumen-fuse
```

The `wpf_macro_list` tool includes a summary so agents know a knowledge base exists without fetching the full resource.

### Macro Saving (AI-Driven)

The `wpf_save_macro` tool lets AI agents save workflows they've performed as reusable macros:

1. Agent performs a workflow using individual MCP tools
2. Agent calls `wpf_save_macro` with the steps as a JSON array
3. Product folder is auto-derived from the attached process name
4. Steps are validated and written as clean YAML
5. The macro is immediately available via `wpf_macro`

```
wpf_save_macro(
  name: "switch-to-diagnostics",
  description: "Switch to the Diagnostics tab via keytips",
  steps: '[{"action":"focus"},{"action":"send_keys","keys":"Alt,2"},{"action":"wait","seconds":1}]'
)
```

---

## Architecture

WPF applications like Fuse require **elevated (admin) privileges** for UI Automation to see the full control tree. Without elevation, UIA only sees a single Win32 TitleBar.

MCP clients can't launch elevated processes via stdio (elevation requires `UseShellExecute = true`, which disables stdio). The solution is a two-process proxy:

```
MCP Client (e.g., OpenCode)
  |  stdio (JSON-RPC)
  v
WpfMcp.exe --mcp-connect     (non-elevated, MCP protocol)
  |  named pipe (WpfMcp_UIA)
  v
WpfMcp.exe                    (elevated, executes UIA commands)
  |  System.Windows.Automation    |  http://*:5112
  v                               v
Target WPF Application         Browser (Blazor Server dashboard)
```

The `--mcp-connect` process auto-launches the elevated server if it isn't already running. The elevated server persists across client reconnections (default 1 hour idle timeout, configurable with `--idle-timeout` or `--no-idle`) and remembers the last attached process for auto-reattach.

Shortcuts and drag-and-drop use the same architecture — the non-elevated client process connects to the elevated server, only triggering UAC if the server isn't already running.

### Detailed Architecture

```
┌─────────────────────────────────────────────────────────────────┐
│  MCP Client (OpenCode, Claude Desktop, etc.)                    │
│  Launches server via stdio                                      │
└──────────────────────────┬──────────────────────────────────────┘
                           │ stdio (JSON-RPC)
                           v
┌─────────────────────────────────────────────────────────────────┐
│  WpfMcp.exe --mcp-connect              (non-elevated process)   │
│                                                                 │
│  Program.cs         Mode routing, auto-launches elevated server │
│  Tools.cs           23 MCP tool definitions                     │
│  UiaProxyClient     Sends JSON requests over named pipe         │
│  ElementCache       Thread-safe LRU ref cache (e1, e2, max 500) │
│  Constants          Shared config (pipe name, timeouts, etc.)   │
└──────────────────────────┬──────────────────────────────────────┘
                           │ named pipe (WpfMcp_UIA)
                           │ JSON protocol: {"method":"...","args":{...}}
                           v
┌─────────────────────────────────────────────────────────────────┐
│  WpfMcp.exe (or --server)               (elevated process)       │
│                                                                 │
│  UiaProxyServer     Listens on pipe, dispatches to UiaEngine    │
│  UiaEngine          Singleton, dedicated STA thread for UIA     │
│    ├─ Attach        Process.GetProcessesByName → FromHandle     │
│    ├─ Snapshot      TreeWalker.RawViewWalker recursive walk     │
│    ├─ Find          PropertyCondition + FindFirst/descendants   │
│    ├─ Click         SetCursorPos + mouse_event (via P/Invoke)   │
│    ├─ SendKeys      SendInput API (modifiers + key combos)      │
│    ├─ TypeText      VkKeyScan per char + keybd_event            │
│    └─ Screenshot    GetWindowRect + Graphics.CopyFromScreen     │
│  MacroEngine        Load/validate/execute/save macros + watcher │
│  WebServer          Blazor Server dashboard on http://*:5112    │
│  AppState           Shared state for pipe server + web dashboard│
│  ElementCache       Server-side ref cache (persists across      │
│                     client reconnections)                       │
└──────────────────────┬─────────────────────┬────────────────────┘
                       │                     │ http://*:5112
                       │ UIA (COM)           v  (Blazor Server)
                       v                   Browser
┌─────────────────────────────────────────────────────────────────┐
│  Target WPF Application (e.g., Deltek Acumen Fuse)              │
│  Automation peers exposed via WPF's built-in UIA support        │
└─────────────────────────────────────────────────────────────────┘
```

### Key Design Decisions

- **STA thread** — All UIA calls run on a dedicated STA thread. WPF automation peers require STA COM marshaling.
- **Lazy singleton** — `UiaEngine` uses `Lazy<T>` with a private constructor. One instance per process.
- **Pipe ACL** — The elevated server pipe grants `ReadWrite` to `AuthenticatedUserSid`, allowing non-elevated clients to connect.
- **Auto-reattach** — Server saves the last process name and reattaches on new client connections.

---

## Development

### Building

```
cd C:\WpfMcp
dotnet build -c Release
```

Output: `WpfMcp\bin\Release\net9.0-windows\WpfMcp.exe`

### Running Tests

```
dotnet test    # 202 tests
```

### CI/CD

GitHub Actions (`.github/workflows/build-release.yml`) runs on every push to `master`:

1. Restores NuGet packages in locked mode for deterministic builds
2. Builds and runs all tests on `windows-latest`
3. Publishes a self-contained single-file exe (no .NET runtime required)
4. Signs the executable (when `SIGNING_CERTIFICATE` secret is configured)
5. Bundles `macros/`, `export-shortcuts.cmd`, `launch-cli.cmd`, and the exe into `WpfMcp.zip`
6. Generates a changelog from commit messages since the previous release tag
7. Creates a GitHub Release with the zip attached, changelog, and auto-generated release notes (version tags use `v{yyyy.MM.dd}.{N}` format)

Pull requests trigger build and test only (no release). Manual runs supported via `workflow_dispatch`.

### Usage Modes

| Mode | Command | Description |
|------|---------|-------------|
| Server (default) | *(no args)* or `--server` | Elevated UIA server + web dashboard on port 5112 |
| MCP (proxied) | `--mcp-connect` | AI agent mode — stdio MCP server proxying to elevated server |
| MCP (direct) | `--mcp` | Testing only — stdio MCP server without elevation |
| CLI | `--cli` | Interactive command prompt for manual testing |
| Run file | `run macro.yaml [k=v ...]` | Execute a YAML macro with optional key=value parameters |
| Drag-and-drop | `WpfMcp.exe macro.yaml` | Run a YAML macro file directly |
| Export all | `--export-all` | Generate shortcuts for all macros |
| No idle | `--no-idle` | Disable idle auto-shutdown (server runs indefinitely) |
| Custom idle | `--idle-timeout <min>` | Set idle timeout in minutes (default: 60, 0 = no idle) |

### Project Structure

```
C:\WpfMcp\
  WpfMcp.slnx                          Solution file
  WpfMcp/
    Program.cs                          Entry point, mode routing, auto-launch logic
    Constants.cs                        Shared constants, path resolution, command names
    Tools.cs                            23 MCP tool definitions
    UiaEngine.cs                        Core UI Automation engine (STA thread, SendInput)
    UiaProxy.cs                         Proxy client/server for named pipe communication
    MacroDefinition.cs                  YAML POCOs for macros, knowledge bases, result records
    MacroEngine.cs                      Load, validate, execute, save, export macros
    MacroSerializer.cs                  YAML serialization (ToYaml, SaveToFile)
    ShortcutCreator.cs                  COM-based Windows shortcut (.lnk) creation
    ElementCache.cs                     Thread-safe LRU element reference cache
    JsonHelpers.cs                      Shared JSON array parsing utilities
    YamlHelpers.cs                      Shared YAML deserializer/serializer instances
    Resources.cs                        MCP resources (knowledge://{productName})
    CliMode.cs                          Interactive CLI for manual testing
    Web/
      WebServer.cs                      Kestrel startup for Blazor Server dashboard
      AppState.cs                       IAppState implementation (wraps UiaEngine + MacroEngine)
  WpfMcp.Web/                           Razor Class Library — Blazor Server dashboard components
    IAppState.cs                        Interface + DTOs (ElementInfo, ActionResult, LogEntry, etc.)
    Components/
      App.razor                         Root: Tailwind config, color tokens, theme JS, custom CSS
      Layout/MainLayout.razor           Header bar with theme toggle and status polling
      Pages/Dashboard.razor             5-zone panel layout (tree, properties, actions, macros, log)
      Shared/                           ElementTree, TreeNode, PropertiesPanel, ActionsPanel,
                                        MacroRunner, LogPanel
  publish/
    macros/                             Version-controlled macro + knowledge base YAML files
    Shortcuts/                          Generated .lnk shortcuts (gitignored)
    export-shortcuts.cmd                Generates .lnk shortcuts for all macros
    launch-cli.cmd                      Opens interactive CLI mode
    run-indefinite.cmd                  Starts server with --no-idle (runs forever)
  WpfMcp.Tests/                         202 xUnit tests
    MacroEngineTests.cs                 128 tests — macro loading, validation, execution, saving, includes, verify match modes, cancellation, parameter default updates
    MacroExportTests.cs                 18 tests — shortcut export, ShortcutCreator
    MacroSerializerTests.cs             6 tests — YAML serialization round-trips
    WpfToolsTests.cs                    9 tests — MCP tool input validation
    ProxyResponseFormattingTests.cs     9 tests — proxy response formatting
    UiaProxyProtocolTests.cs            9 tests — named pipe protocol + deadlock reproduction
    UiaProxyClientTests.cs              3 tests — proxy client edge cases
```

## Troubleshooting

**"Access to the path is denied" on pipe connection**
The elevated server creates the pipe with an ACL that allows authenticated users. Ensure the `--server` process is actually elevated.

**Snapshot only shows TitleBar / FrameworkId="Win32"**
The server process is not elevated. Kill it and re-launch — approve the elevation prompt.

**"Not attached to any process"**
Call `wpf_attach` with the process name. After the first attach, the server remembers the process and auto-reattaches on reconnection.

**Server shuts down after 1 hour**
The elevated server has a default 1-hour idle timeout. Use `--idle-timeout <minutes>` to change it, or `--no-idle` to disable auto-shutdown entirely. Run `run-indefinite.cmd` for a server that never shuts down. The server auto-relaunches when the next client starts.

**MCP server hangs after running a slow macro**
Long-running macros (e.g., file imports exceeding ~15-20s) can deadlock the MCP proxy pipe. All subsequent tool calls will hang. Restart the MCP server to recover. This is a known bug — the pipe client holds a lock with no cancellation token during the entire request/response cycle.

**Dashboard won't open / port 5112 in use**
The server auto-launches the browser after 3 seconds. If you dismissed it, navigate to `http://localhost:5112` manually. If the port is in use, kill the conflicting process (`taskkill /IM WpfMcp.exe /F`) and restart.

**Build errors about Infragistics NuGet source**
The `nuget.config` file clears external sources. Make sure it's present in the project root.
