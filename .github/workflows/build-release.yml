name: Build, Test & Release

on:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.0.x'

      - name: Cache NuGet packages
        uses: actions/cache@v4
        with:
          path: ~/.nuget/packages
          key: nuget-${{ runner.os }}-${{ hashFiles('**/packages.lock.json') }}
          restore-keys: |
            nuget-${{ runner.os }}-

      - name: Restore
        run: dotnet restore --locked-mode

      - name: Build
        run: dotnet build -c Release --no-restore

      - name: Test
        run: dotnet test -c Release --no-build --verbosity normal

      - name: Publish
        run: dotnet publish WpfMcp/WpfMcp.csproj -c Release -r win-x64 --self-contained true -p:PublishSingleFile=true -p:IncludeNativeLibrariesForSelfExtract=true -o dist

      - name: Sign executable
        if: github.ref == 'refs/heads/master' && github.event_name == 'push' && env.SIGNING_CERTIFICATE != ''
        env:
          SIGNING_CERTIFICATE: ${{ secrets.SIGNING_CERTIFICATE }}
          SIGNING_CERTIFICATE_PASSWORD: ${{ secrets.SIGNING_CERTIFICATE_PASSWORD }}
        run: |
          # Decode certificate from base64 secret
          $certBytes = [Convert]::FromBase64String($env:SIGNING_CERTIFICATE)
          $certPath = Join-Path $env:RUNNER_TEMP "code_signing.pfx"
          [IO.File]::WriteAllBytes($certPath, $certBytes)

          # Find signtool.exe from Windows SDK
          $signtool = Get-ChildItem -Path "C:\Program Files (x86)\Windows Kits\10\bin" -Recurse -Filter "signtool.exe" |
            Where-Object { $_.FullName -match "x64" } |
            Sort-Object FullName -Descending |
            Select-Object -First 1 -ExpandProperty FullName

          # Sign the exe with SHA-256 and timestamp
          & $signtool sign /f $certPath /p $env:SIGNING_CERTIFICATE_PASSWORD /fd SHA256 /tr http://timestamp.digicert.com /td SHA256 /d "WPF MCP Server" dist\WpfMcp.exe

          # Clean up
          Remove-Item $certPath -Force

      - name: Create release zip
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        run: Compress-Archive -Path dist\WpfMcp.exe, publish\macros, publish\export-shortcuts.cmd, publish\launch-cli.cmd -DestinationPath dist\WpfMcp.zip

      - name: Generate version tag
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        id: version
        run: |
          $date = Get-Date -Format "yyyy.MM.dd"
          # Find the next sequential build number for today
          $existing = git tag -l "v$date.*" | ForEach-Object { [int]($_ -replace "v$date\.","") } | Sort-Object -Descending | Select-Object -First 1
          $build = if ($existing) { $existing + 1 } else { 1 }
          echo "tag=v$date.$build" >> $env:GITHUB_OUTPUT
          echo "name=Release $date.$build" >> $env:GITHUB_OUTPUT

      - name: Generate changelog
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        id: changelog
        run: |
          # Find the previous release tag (most recent tag sorted by date)
          $prevTag = git tag --sort=-creatordate | Select-Object -First 1
          if ($prevTag) {
            $log = git log --oneline --no-merges "$prevTag..HEAD"
          } else {
            # No previous tag â€” use last 20 commits
            $log = git log --oneline --no-merges -20
          }

          # Build changelog markdown
          if ($log) {
            $lines = @($log) | ForEach-Object {
              if ($_.Length -gt 8) {
                $hash = $_.Substring(0, 7)
                $msg = $_.Substring(8)
                "- ``$hash`` $msg"
              } else {
                "- $_"
              }
            }
            $body = "## Changes`n`n" + ($lines -join "`n")
          } else {
            $body = "## Changes`n`nNo new commits since last release."
          }

          # Write to file (avoids multiline output escaping issues)
          $body | Out-File -FilePath changelog.md -Encoding utf8

      - name: Create Release
        if: github.ref == 'refs/heads/master' && github.event_name == 'push'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: ${{ steps.version.outputs.name }}
          body_path: changelog.md
          generate_release_notes: true
          files: dist/WpfMcp.zip
